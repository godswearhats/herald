<!DOCTYPE html>
<html>
<head>
	<title>Armies</title>
  <meta charset="utf-8"/>
	<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css" />
  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
	<script src="lib/jquery-2.2.4.js"></script>
	<script src="lib/jquery.mobile-1.4.5.js"></script>
	<script src="js/template.js"></script>
	<script src="js/list.js"></script>
	<script src="js/artifact.js"></script>
	<script src="js/files.js"></script>
  
	<script type="text/javascript">
    var current = {
      race: null,
      template: null,
      list: null,
      entry: null,
      unit: null,
      artifact: null,
      spells: null,
      options: null
    }
    var armies = new Armies() // load is called in index.js
    var artifacts

		$(function(){
			$( "[data-role='header']" ).toolbar( {'theme': 'a'})
      // $( "[data-role='header'], [data-role='footer']" ).toolbar( {'theme': 'a'}) put back in when footer is needed
		})
    // Update the contents of the toolbars
    $(document).on('pagecontainerchange', function(event, ui) {
        // console.log("Change of page: current = ", current)
        let title = $('.ui-page-active').jqmData('title')
        if (title) {
          $('#header-title').text(title)
        }
        let action = $('.ui-page-active').jqmData('action')
        if (action) {
          $('#header-action').attr('href', action).show()
        }
        else {
          $('#header-action').hide()
        }
        
        let back = $('.ui-page-active').jqmData('back')
        if (back) {
          $('#header-back').attr('href', back).show()
        }
    })
	</script>
</head>

<body>

<!-- Header and footer -->
<div id="header" data-role="header">
	<a id="header-menu" href="#army-lists" class="ui-btn ui-btn-icon-left ui-icon-bars ui-btn-icon-notext ui-corner-all ui-btn-inline">Menu</a>
	<h3 id="header-title">Elves</h3>
	<a id="header-action" href="#" class="ui-btn ui-btn-b ui-icon-plus ui-btn-icon-right ui-btn-icon-notext ui-corner-all ui-btn-inline">Add Unit</a>
</div>

<!-- <div id="footer" data-role="footer">
  <div id="navbar" data-role="navbar">
    <ul>
      <li><a href="#armies" class="ui-btn-active">Armies</a></li>
      <li><a href="#battles">Battles</a></li>
      <li><a href="#events">Events</a></li>
    </ul>
  </div>
</div> -->

<!-- #army-list: List of all the armies created -->
<div data-role="page" data-title="Armies" data-action="#new" id="army-lists">
	<div role="main" class="ui-content">
	</div>
	<script type="text/javascript">
		$('#army-lists').on("pagebeforeshow", function(event, ui) {
      $('#army-lists > div.ui-content').html(armies.listsToHTML())
  		$('a.army-list').on('click', function (event) {
        current.list = armies.lists[event.currentTarget.dataset.list]
        current.race = current.list.race
  		})
  	})
	</script>
</div>

  <!-- #new: Create a new army -->
<div data-role="page" data-title="Create new army" id="new">
  <div role="main" class="ui-content">
	</div>
	<script type="text/javascript">
		$('#new').on("pagebeforeshow", function(event, ui) {
      $('#new > div.ui-content').html(armies.toHTML())
  		$('a.build').on('click', function (event) {
        current.race = event.currentTarget.dataset.race
  		})
  	})
	</script>
</div>

<!-- #popup-list-details: Popup for army name (and maybe points later TODO)  FIXME this doesn't pop up -->
<div data-role="popup" id="popup-list-details" data-theme="a" class="ui-corner-all" data-dismissible="false">
    <form>
        <div style="padding:10px 20px;">
            <label for="list-label">Army name:</label>
            <input name="list-label" id="list-label" value="" data-theme="a" type="text">
            <a href="#new" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-rel="back">Back</a>
            <a href="#build" class="create ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-transition="flow">Create</a> 
        </div>
    </form>
    <script type="text/javascript">
  		$('a.create').on('click', function (event) {
        current.list = new ArmyList( $('#list-label').val(), current.race )
        $('#build').jqmData('title', current.list.label)
        $('#list-label').val('')
      })      
    </script>
</div>

<!-- #build: actually build your army -->
<div data-role="page" id="build" data-action="#show-units" data-back="#new">
	<style>
		span.count-valid {
			color: #333;
      font-weight: bold;
		}
		span.count-not-ok {
			color: #8D0002;
		}
		span.count-invalid {
			color: #C36F0E;
		}
    #army-header {
      text-align: left;
    }
	</style>
	<div role="main" class="ui-content">
		<ul data-role="listview" id="army-entries">
			<li id="army-header">	
				Drops: <span id="drop-count" class="count-ok">0</span>
				Unit Strength: <span id="unit-strength" class="count-ok">0</span>
				Points: <span id="point-total" class="count-ok">0</span>
        <span id="army-valid">&9989;</span>
			</li>
		</ul>
	</div>
	<script type="text/javascript">
    function updateList() {
			$('#drop-count').text(current.list.drops())
			$('#unit-strength').text(current.list.unitStrength())
      $('#point-total').text(current.list.points)
      current.list.isValid() ? $('#army-valid').html('&#9989;').toggleClass('count-valid count-invalid') : $('#army-valid').html('&#9888;').toggleClass('count-valid count-invalid')
      current.list.save() // exciting!
			$('#army-entries').listview('refresh')
    }
		$('#build').on("pagebeforeshow", function(event, ui) {
      if (!current.template || current.race !== current.template.race) { // new arrmy
        current.template = armies[current.race]
      }
      updateList()
		})
	</script>
</div>

<!-- #unit-details: customize a given unit -->
<div data-role="page" id="unit-details" data-back="#show-units">
	<div class="ui-content" role="main">
    <div style="padding-bottom: 15px">
      <ul data-role="listview" data-inset="true" id="entry-wrapper">
      </ul>
    </div>
    <a href="#artifacts" class="ui-btn">Add Artifact</a>
		<a href="#build" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
		<a href="#build" id="save-unit" class="ui-btn ui-btn-inline ui-mini">Save</a>
	</div>
	<script type="text/javascript">
    function addCurrentUnit(event) {
      current.list.addEntry(current.entry)
      $('#army-entries').append(current.entry.toHTML())
      current.entry = current.unit = current.artifact = current.spells = current.options = null
    }
		$('#save-unit').on('click', addCurrentUnit)
    
		$('#unit-details').on('pagebeforeshow', function() {
      current.entry = ListEntry.entryFromCurrent()
			$('#entry-wrapper').html(current.entry.toHTML())
			$('#entry-wrapper').listview('refresh')
		})
	</script>
</div>

<!-- #artifacts: list of magical artifacts -->
<div data-role="page" id="artifacts" data-theme="a" data-back="unit-details">
	<div role="main" class="ui-content" id="artifacts-content">
		<form class="ui-filterable">
				<input id="artifacts-autocomplete" data-type="search" placeholder="Search artifacts...">
		</form>
	</div>
  <script type="text/javascript">
    $('#artifacts').one('pagebeforeshow', function() {
      $('#artifacts-content').append(artifacts.asList())
    })
  </script>
</div>

<!-- #show-units: show the units for your army -->
<div data-role="page" id="show-units" data-title="Units" data-back="#build">
  <div role="main" class="ui-content">
		<style>
			table {
			  border-collapse: collapse;
			}
      table tr:nth-child(odd) td{
        background-color: white;
      }
			th {
				text-align: center;
				font-size: 80%;
				padding-right: 9px;
			}
			td {
				text-align: center;
				font-weight: lighter;
				font-size: 80%;
				padding-right: 7px;

			}
			h2 {
				margin-top: 0px;
				margin-bottom: 0px;
			}
      .unit-name {
        float: left;
      }
      .unit-type {
        float: right;
        font-size: 75%;
        color: gray;
      }
		</style>
		<form class="ui-filterable">
		    <input id="filter-units" data-type="search">
		</form>
    <div data-filter="true" data-role="collapsibleset" data-input="#filter-units" id="unit-choices">
    </div>
		<a href="#unit-details" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
		<a href="#unit-details" id="save-artifact" class="ui-btn ui-btn-inline ui-mini">Save</a>
		<script type="text/javascript">
			$('#show-units').on('pagebeforeshow', function() {
        armies.templates[current.race].toHTML('#unit-choices')
			})
    </script>
	</div>
</div>

</body>

</html>
