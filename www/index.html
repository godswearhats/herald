<!DOCTYPE html>
<html>
<head>
  <title>Armies</title>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
  <meta name="format-detection" content="telephone=no">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
  <link rel="stylesheet" href="css/jquery.mobile-1.4.5.css" />
  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script src="lib/jquery-2.1.4.js"></script>
  <script src="lib/jquery.mobile-1.4.5.js"></script>
  <script src="js/template.js"></script>
  <script src="js/list.js"></script>
  <script src="js/artifact.js"></script>
  <script src="js/files.js"></script>
  
  <script type="text/javascript">
    var heraldLoaded = false
    var current = {
      race: null,
      template: null,
      list: null,
      entry: null,
      unit: null,
      artifact: null,
      spells: null,
      options: null
    }
    var armies = new Armies() // load is called in index.js
    var artifacts

    $(function(){
      $( "[data-role='header']" ).toolbar( {'theme': 'a'})
      // $( "[data-role='header'], [data-role='footer']" ).toolbar( {'theme': 'a'}) put back in when footer is needed
    })
    // Update the contents of the toolbars
    $(document).on('pagecontainerchange', function(event, ui) {
        let title = $('.ui-page-active').jqmData('title')
        if (title) {
          $('#header-title').text(title)
        }
        let action = $('.ui-page-active').jqmData('action')
        if (action) {
          $('#header-action').attr('href', action).show()
        }
        else {
          $('#header-action').hide()
        }
        
        let back = $('.ui-page-active').jqmData('back')
        if (back) {
          $('#header-back').attr('href', back).show()
        }
        else {
          $('#header-back').hide()
        }
    })
  </script>
</head>

<body>

<!-- Header and footer -->
<div id="header" data-role="header">
  <a id="header-back" class="ui-btn ui-btn-icon-left ui-icon-back ui-btn-icon-notext ui-corner-all ui-btn-inline">Menu</a>
  <h3 id="header-title">Herald</h3>
  <a id="header-action" href="#" class="ui-btn ui-btn-b ui-icon-plus ui-btn-icon-right ui-btn-icon-notext ui-corner-all ui-btn-inline">Add Unit</a>
</div>

<!-- <div id="footer" data-role="footer">
  <div id="navbar" data-role="navbar">
    <ul>
      <li><a href="#armies" class="ui-btn-active">Armies</a></li>
      <li><a href="#battles">Battles</a></li>
      <li><a href="#events">Events</a></li>
    </ul>
  </div>
</div> -->

<!-- #army-list: List of all the armies created -->
<div data-role="page" data-title="Armies" data-action="#new" id="army-lists">
  <div role="main" class="ui-content">
    Loading ...
  </div>
  <script type="text/javascript">
    function updateAllLists() {
      $('#army-lists > div.ui-content').html(armies.listsToHTML()) // sync
      $('a.army-list').on('click', function (event) { // sync
        current.race = event.currentTarget.dataset.race
        current.list = armies.lists.get(current.race).get(event.currentTarget.dataset.label)
        $('#build').jqmData('title', current.list.label)
        $('#build > div.ui-content').html(current.list.toHTML())
      })
    }
    $('#army-lists').on("pagebeforeshow", function(event, ui) { // async but ok
      if (heraldLoaded) {
        updateAllLists()
      }
      else {
        var intervalId = window.setInterval(function () {
          if (heraldLoaded) {
            updateAllLists()
            window.clearInterval(intervalId)
          }
        }, 100)
      }
    })
  </script>
</div>

  <!-- #new: Create a new army -->
<div data-role="page" data-title="Create new army" data-back="#army-lists" id="new">
  <!-- #popup-list-details: Popup for army name (and maybe points later TODO) -->
  <div data-role="popup" data-position-to="origin" data-transition="slidedown" id="popup-list-details" data-theme="a" class="ui-corner-all" data-dismissible="false">
      <form>
          <div style="padding:10px 20px;">
              <label for="list-label">Army name:</label>
              <input name="list-label" id="list-label" value="" data-theme="a" type="text">
              <a href="#new" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-rel="back">Back</a>
              <a href="#build" class="create-new-army ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-transition="flow">Create</a> 
          </div>
      </form>
      <script type="text/javascript">
        $('a.create-new-army').on('click', function (event) { // async, but OK
          current.list = new ArmyList( $('#list-label').val(), current.race )
          current.list.save(true)
          $('#build').jqmData('title', current.list.label)
          $('#build > div.ui-content').html(current.list.toHTML())
          $('#list-label').val('')
        })      
      </script>
  </div>
  <div role="main" class="ui-content">
    <div id="army-templates">
      
    </div>
  </div>

  <script type="text/javascript">
    $('#new').on("pagebeforeshow", function(event, ui) { // sync
      $('#army-templates').html(armies.toHTML())
    })
  </script>

</div>

<!-- #build: actually build your army -->
<div data-role="page" data-action="#show-units" data-back="#new" id="build">
  <style>
    span.count-valid {
      color: #333;
      font-weight: bold;
    }
    span.count-not-ok {
      color: #8D0002;
    }
    span.count-invalid {
      color: #C36F0E;
    }
    #army-header {
      text-align: left;
    }
  </style>
  <div role="main" class="ui-content">
  </div>
  <script type="text/javascript">
    $('#build').on("pagebeforeshow", function(event, ui) {
      if (!current.template || current.race !== current.template.race) { // new army -- sync
        current.template = armies.templates.get(current.race)
      }
    })
  </script>
</div>

<!-- #unit-details: customize a given unit -->
<div data-role="page" data-back="#show-units" id="unit-details">
  <div class="ui-content" role="main">
    <div style="padding-bottom: 15px">
      <ul data-role="listview" data-inset="true" id="entry-wrapper">
      </ul>
    </div>
    <a href="#artifacts" class="ui-btn">Add Artifact</a>
    <a href="#build" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
    <a href="#build" id="save-unit" class="ui-btn ui-btn-inline ui-mini">Save</a>
  </div>
  <script type="text/javascript">
    function addCurrentUnit(event) { // sync
      current.entry.updateHTML()
      current.list.addEntry(current.entry)
      $('#build > div.ui-content').html(current.list.toHTML())   
      current.entry = current.unit = current.artifact = current.spells = current.options = null
    }
    $('#save-unit').on('click', addCurrentUnit)
    
    $('#unit-details').on('pagebeforeshow', function() { // sync
      current.entry = ListEntry.entryFromCurrent()
      $('#entry-wrapper').html(current.entry.toHTML())
      $('#entry-wrapper').listview('refresh')
    })
  </script>
</div>

<!-- #artifacts: list of magical artifacts -->
<div data-role="page" data-theme="a" data-back="#unit-details" id="artifacts">
  <div role="main" class="ui-content" id="artifacts-content">
    <form class="ui-filterable">
        <input id="artifacts-autocomplete" data-type="search" placeholder="Search artifacts...">
    </form>
  </div>
  <script type="text/javascript">
    $('#artifacts').one('pagebeforeshow', function() { // async but ok
      $('#artifacts-content').append(artifacts.asList())
    })
  </script>
</div>

<!-- #show-units: show the units for your army -->
<div data-role="page" data-title="Units" data-back="#army-lists" id="show-units">
  <div role="main" class="ui-content">
    <style>
      table {
        border-collapse: collapse;
      }
      table tr:nth-child(odd) td{
        background-color: white;
      }
      th {
        text-align: center;
        font-size: 80%;
        padding-right: 9px;
      }
      td {
        text-align: center;
        font-weight: lighter;
        font-size: 80%;
        padding-right: 7px;

      }
      h2 {
        margin-top: 0px;
        margin-bottom: 0px;
      }
      .unit-name {
        float: left;
      }
      .unit-type {
        float: right;
        font-size: 75%;
        color: gray;
      }
    </style>
    <form class="ui-filterable">
        <input id="filter-units" data-type="search">
    </form>
    <div data-filter="true" data-role="collapsibleset" data-input="#filter-units" id="unit-choices">
    </div>
    <a href="#unit-details" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
    <a href="#unit-details" id="save-artifact" class="ui-btn ui-btn-inline ui-mini">Save</a>
    <script type="text/javascript">
      $('#show-units').on('pagebeforeshow', function() {
        armies.templates.get(current.race).toHTML('#unit-choices')
      })
    </script>
  </div>
</div>

</body>

</html>
