<!DOCTYPE html>
<html>
<head>
	<title>Armies</title>
  <meta charset="utf-8"/>
	<meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" href="css/jquery.mobile-1.4.5.css" />
  <script type="text/javascript" src="cordova.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
	<script src="lib/jquery-2.2.4.js"></script>
	<script src="lib/jquery.mobile-1.4.5.js"></script>
	<script src="js/template.js"></script>
	<script src="js/list.js"></script>
	<script src="js/artifact.js"></script>
	<script src="js/files.js"></script>
  
	<script type="text/javascript">
    var current = {
      race: 'elves', // FIXME
      template: null,
      list: null,
      entry: null,
      unit: null,
      artifact: null,
      spells: null,
      options: null
    }
    var armies = new Armies()
    
    var artifacts
    $.ajax({
      url: 'data/artifacts.json',
      beforeSend: function(xhr){
        if (xhr.overrideMimeType)
        {
          xhr.overrideMimeType("application/json");
        }
      },
      dataType: 'json',
      success: function(data) {
        artifacts = new ArtifactList(data)
      }
    })

		$(function(){
			$( "[data-role='header']" ).toolbar( {'theme': 'a'})
      // $( "[data-role='header'], [data-role='footer']" ).toolbar( {'theme': 'a'})
		})
    // Update the contents of the toolbars
    $(document).on('pagecontainerchange', function(event, ui) {
        // TODO highlight buttons for navbar
        var title = $('.ui-page-active').jqmData('title')
        if (title) {
          $('#header-title').text(title)
        }
        var action = $('.ui-page-active').jqmData('action')
        if (action) {
          $('#header-action').attr('href', action).show()
        }
        else {
          $('#header-action').hide()
        }
    })
	</script>
</head>

<body>

<!-- Header and footer -->
<div id="header" data-role="header">
	<a id="header-menu" href="#new" class="ui-btn ui-btn-icon-left ui-icon-bars ui-btn-icon-notext ui-corner-all ui-btn-inline">Menu</a>
	<h3 id="header-title">Elves</h3>
	<a id="header-action" href="#" class="ui-btn ui-btn-b ui-icon-plus ui-btn-icon-right ui-btn-icon-notext ui-corner-all ui-btn-inline">Add Unit</a>
</div>

<!-- <div id="footer" data-role="footer">
  <div id="navbar" data-role="navbar">
    <ul>
      <li><a href="#armies" class="ui-btn-active">Armies</a></li>
      <li><a href="#battles">Battles</a></li>
      <li><a href="#events">Events</a></li>
    </ul>
  </div>
</div> -->

<!-- #army-list: List of all the armies created -->
<div data-role="page" data-title="Armies" data-action="#new" id="army-list">
	<div role="main" class="ui-content">

    <ul data-role="listview" data-divider-theme="a">
        <li data-role="list-divider">Elves <span class="ui-li-count">2</span></li>
        <li><a href="#build">Wet Coast 2250</a></li>
        <li><a href="#build">Dragon Rider 2000</a></li>
        <li data-role="list-divider">The Herd <span class="ui-li-count">1</span></li>
        <li><a href="#build">Joe's army</a></li>
    </ul>
	</div>
</div>

  <!-- #new: Create a new army -->
<div data-role="page" data-title="Create new army" id="new">
  <div role="main" class="ui-content">
    <ul data-role="listview">
      <li><a href="#popup-list-details" data-rel="pop-up" data-position-to="window" data-transition="pop" class="build" data-army="elves">Elves <span class="ui-li-count">2</span></a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="herd">The Herd<span class="ui-li-count">1</span></a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="abyssal-dwarfs">Abyssal Dwarfs</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="abyss">Forces of the Abyss</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="dwarfs">Dwarfs</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="dust">Empire of Dust</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="basilea">Forces of Basilea</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="nature">Forces of Nature</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="goblins">Goblins</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="men">Kingdoms of Men</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="ogres">Ogres</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="ratkin">Ratkin</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="salamanders">Salamanders</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="brotherhood">The Brotherhood</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="rhordia">The League of Rhordia</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="trident">The Trident Realm of Neritica</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="kin">Twilight Kin</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="undead">Undead</a></li>
      <li><a href="#popup-list-details" data-position-to="window" data-transition="pop" class="build" data-army="varangur">Varangur</a></li>
    </ul>
	</div>
	<script type="text/javascript">
		$('a.build').on('click', function (event) {
      current.race = event.currentTarget.dataset.army
      // $('#army-list-name').placeholder // TODO something fun here
		})
	</script>
</div>

<!-- #popup-list-detials: Popup for army name (and maybe points later TODO) -->
<div data-role="popup" id="popup-list-details" data-theme="a" class="ui-corner-all" data-dismissible="false">
    <form>
        <div style="padding:10px 20px;">
            <label for="list-label">Army name:</label>
            <input name="list-label" id="list-label" value="" data-theme="a" type="text">
            <a href="#new" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-rel="back">Back</a>
            <a href="#build" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-a" data-transition="flow">Create</a> 
        </div>
    </form>
</div>

<!-- #build: actually build your army -->
<div data-role="page" id="build" data-action="#show-units" data-title="Add units &rarr;">
	<style>
		span.count-valid {
			color: #333;
      font-weight: bold;
		}
		span.count-not-ok {
			color: #8D0002;
		}
		span.count-invalid {
			color: #C36F0E;
		}
    #army-header {
      text-align: left;
    }
	</style>
	<div role="main" class="ui-content">
		<ul data-role="listview" id="army-entries">
			<li id="army-header">	
				Drops: <span id="drop-count" class="count-ok">0</span>
				Unit Strength: <span id="unit-strength" class="count-ok">0</span>
				Points: <span id="point-total" class="count-ok">0</span>
        <span id="army-valid">&9989;</span>
			</li>
		</ul>
	</div>
	<script type="text/javascript">
    function updateList() {
			$('#drop-count').text(current.list.drops())
			$('#unit-strength').text(current.list.unitStrength())
      $('#point-total').text(current.list.points)
      current.list.isValid() ? $('#army-valid').html('&#9989;').toggleClass('count-valid count-invalid') : $('#army-valid').html('&#9888;').toggleClass('count-valid count-invalid')
			$('#army-entries').listview('refresh')
    }
		$('#build').on("pagebeforeshow", function(event, ui) {
      if (current.template && current.template.race && current.race === current.template.race) {
        updateList()
      }
      else {
        $.ajax({
          url: 'data/' + current.race + '.json',
          beforeSend: function(xhr){
            if (xhr.overrideMimeType)
            {
              xhr.overrideMimeType("application/json");
            }
          },
          dataType: 'json',
          success: function(data) {
            current.template = new ArmyTemplate(current.race, data)
            current.list = new ArmyList( $('#list-label').val() )
            updateList()
          }
        })
      } 
		})
	</script>
</div>

<!-- #unit-details: customize a given unit -->
<div data-role="page" id="unit-details">
	<div class="ui-content" role="main">
    <div style="padding-bottom: 15px">
      <ul data-role="listview" data-inset="true" id="entry-wrapper">
      </ul>
    </div>
    <a href="#artifacts" class="ui-btn">Add Artifact</a>
		<a href="#build" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
		<a href="#build" id="save-unit" class="ui-btn ui-btn-inline ui-mini">Save</a>
	</div>
	<script type="text/javascript">
    function addCurrentUnit(event) {
      current.list.addEntry(current.entry)
      $('#army-entries').append(current.entry.toHTML())
      current.entry = current.unit = current.artifact = current.spells = current.options = null
    }
		$('#save-unit').one('click', addCurrentUnit)
    
		$('#unit-details').on('pagebeforeshow', function() {
      current.entry = ListEntry.entryFromCurrent()
			$('#entry-wrapper').html(current.entry.toHTML())
			$('#entry-wrapper').listview('refresh')
		})
	</script>
</div>

<!-- #artifacts: list of magical artifacts -->
<div data-role="page" id="artifacts" data-theme="a">
	<div role="main" class="ui-content" id="artifacts-content">
		<form class="ui-filterable">
				<input id="artifacts-autocomplete" data-type="search" placeholder="Search artifacts...">
		</form>
	</div>
  <script type="text/javascript">
    $('#artifacts').one('pagebeforeshow', function() {
      $('#artifacts-content').append(artifacts.asList())
    })
  </script>
</div>

<!-- #show-units: show the units for your army -->
<div data-role="page" id="show-units" data-title="Units">
  <div role="main" class="ui-content">
		<style>
			table {
			  border-collapse: collapse;
			}
      table tr:nth-child(odd) td{
        background-color: white;
      }
			th {
				text-align: center;
				font-size: 80%;
				padding-right: 9px;
			}
			td {
				text-align: center;
				font-weight: lighter;
				font-size: 80%;
				padding-right: 7px;

			}
			h2 {
				margin-top: 0px;
				margin-bottom: 0px;
			}
      .unit-name {
        float: left;
      }
      .unit-type {
        float: right;
        font-size: 75%;
        color: gray;
      }
		</style>
		<form class="ui-filterable">
		    <input id="filter-units" data-type="search">
		</form>
    <div data-filter="true" data-role="collapsibleset" data-input="#filter-units" id="unit-choices">
    </div>
		<a href="#unit-details" class="ui-btn ui-btn-inline ui-mini">Cancel</a>
		<a href="#unit-details" id="save-artifact" class="ui-btn ui-btn-inline ui-mini">Save</a>
		<script type="text/javascript">
			$('#show-units').one('pagebeforeshow', function() {
        current.template.toHTML('#unit-choices')
			})
    </script>
	</div>
</div>

</body>

</html>
