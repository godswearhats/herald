var unitBeingRotated=!1,mouseStartAngle=!1,unitStartAngle=!1,reportStarted=!1;
(function(a){a.fn.playable=function(){return this.each(function(){a(this).draggable({cancel:".handle"}).hover(function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").show()},function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").hide()}).rotatable().deletable()})};a.fn.rotatable=function(){return this.each(function(){a(this).data("angle",0);var b=a(document.createElement("div")).addClass("handle").addClass("control").draggable({opacity:0.01,helper:"clone",
start:dragStart}).hide().on("mousedown",startRotate).appendTo(a(this));addPlayerClass(a(this),b)})};a.fn.deletable=function(){var b=a(this),c=a(document.createElement("div")).data("unit",b.attr("id")).attr("title","Delete this?").addClass("dialog").dialog({resizable:!1,height:"40px",width:"160px",modal:!0,autoOpen:!1,buttons:{Delete:function(){a(this).dialog("close");a(this).data("unit");a("#"+a(this).data("unit")).remove()},Cancel:function(){a(this).dialog("close")}}}),d=a(document.createElement("div")).appendTo(b).addClass("delete-button").addClass("control").hide().on("click",
function(){c.dialog("open");return!1});addPlayerClass(b,d)}})(jQuery);
$(function(){$(document).on("mouseup",stopRotate);$(".add-unit").on("click",addUnit);$(".update-unit").on("click",updateUnit);initializeSceneryManager();$("#control-panel").tabs({activate:function(a,b){$(".unit").draggable("disable");var c=b.newPanel.data("player");c?($(".unit").draggable("disable"),$(".unit.player-"+c).draggable("enable")):$(".unit").draggable("enable")}});$("#add-remote-scenery").on("click",loadRemoteScenery);$("#dump-button").on("click",dumpHTML);$("#slurp-button").on("click",
slurpHTML);$("#start-report").on("click",toggleReportState)});function addPlayerClass(a,b){var c=a.data("player");c&&b.addClass("player-"+c)}function toggleReportState(){reportStarted?(reportStarted=!1,$("#start-report").text("Start Report (locks scenery)"),$(".scenery").draggable({cancel:".handle"}).resizable({autoHide:!0,aspectRatio:!0})):(reportStarted=!0,$("#start-report").text("Stop Report (unlocks scenery)"),$(".scenery").draggable("destroy").resizable("destroy"))}
function initializeSceneryManager(){for(var a=["tower","wall","tree","corner_hill","hill"],b=0;b<a.length;b++)createSceneryButton("img/"+a[b]+".png",a[b].replace("_"," "),!0,"#scenery-manager");createSceneryButton("img/red_arrow.png","Player 1",!1,"#report");createSceneryButton("img/blue_arrow.png","Player 2",!1,"#report")}function loadRemoteScenery(){var a=$("#scenery-url").val(),b=$("#scenery-label").val();createSceneryButton(a,b,!0,"#scenery-manager")}
function createSceneryButton(a,b,c,d){$(document.createElement("img")).attr({src:a,alt:b}).data({isScenery:c,controlPanelID:d}).load(function(){$(document.createElement("button")).appendTo($(d)).on("click",{src:this.src,height:this.height,width:this.width,isScenery:c},addScenery).text(this.alt)})}function addScenery(a){var b="scenery-unit-"+getNextID(".scenery");createScenery(b,{artifactType:"scenery",height:a.data.height,width:a.data.width,src:a.data.src,isScenery:a.data.isScenery})}
function createScenery(a,b){var c=$(document.createElement("div")).addClass("scenery").addClass("artifact").attr("id",a).data(b).css({height:b.height+"px",width:b.width+"px","z-index":10,"background-image":"url("+b.src+")","background-repeat":"none"}).resizable({autoHide:!0,aspectRatio:b.isScenery});b.isScenery||addMeasurementHooks(c,b.height);$("#battlefield").append(c);c.playable();return c}
function addMeasurementHooks(a,b){a.on("resize",function(a,b){b.element.children(".scenery-size").show().text(toNearestTenth(pxToInches(b.size.height))+"in.")});$(document.createElement("div")).text(toNearestTenth(pxToInches(b))+"in.").addClass("scenery-size").addClass("control").hide().appendTo(a);return a}
function addUnit(a){var a=parseInt(a.target.parentElement.parentElement.dataset.player),b="player-"+a+"-unit-"+getNextID(".player-"+a),c=initializeUnitData(a,{artifactType:"unit"});createUnit(a,b,c);resetUnitManagerInfo(a)}
function initializeUnitData(a,b){var c="#player-"+a+"-unit-",d=$(c+"base-size").val().split("x");b.baseWidth=d[0];b.baseHeight=d[1];b.looseFormation=$(c+"loose-formation").is(":checked");b.ranks=parseInt($(c+"ranks").val());b.files=parseInt($(c+"files").val());b.title=$(c+"title").val();return b}function getNextID(a){var b=0;$(a).each(function(){var a=parseInt($(this).attr("id").split("-").pop());a>b&&(b=a)});return b}
function createUnit(a,b,c){var d=$(document.createElement("div")).attr("id",b).data(c).data("player",a).addClass("unit").addClass("artifact").addClass("player-"+a),e=$(document.createElement("div")).css("clear","both").addClass("unit-title").text(c.title);1==parseInt(a)&&e.appendTo(d);addModelsToUnit(d,c.ranks,c.files,c.baseWidth,c.baseHeight,c.looseFormation);2==parseInt(a)&&e.appendTo(d);$("#battlefield").append(d);d.playable();d.on("click",{unitID:b},highlightUnit);return d}
function updateUnit(a){var b=$("#"+$(a.target).data("unit")),a=b.data(),c=b.attr("id");b.remove();b=createUnit(a.player,c,initializeUnitData(a.player,a));updateArtifactPosition(b,a);resetUnitManagerInfo(a.player)}function resetUnitManagerInfo(a){setUnitManagerInfo(a,defaultUnitData());$("#unit-manager-player-"+a+" .update-unit").prop("disabled",!0)}
function highlightUnit(a){var b=$("#"+a.data.unitID),c=b.children(".unit-models");deselectAllUnits(a);c.css({"box-shadow":"8px 8px 20px #000"});displayUnitInfo(b)}function displayUnitInfo(a){var b=parseInt(a.data("player"));$("#control-panel").tabs("select",b);setUnitManagerInfo(b,a.data());$("#unit-manager-player-"+b+" .update-unit").prop("disabled",!1).data("unit",a.attr("id"))}
function setUnitManagerInfo(a,b){var c="#player-"+a+"-unit-";$(c+"ranks").val(b.ranks);$(c+"files").val(b.files);$(c+"title").val(b.title);$(c+'base-size option[value="'+b.baseHeight+"x"+b.baseWidth+'"]').prop("selected",!0);$(c+"loose-formation").prop("checked",b.looseFormation)}function defaultUnitData(){return{ranks:"",files:"",title:"",baseHeight:20,baseWidth:20,looseFormation:!1}}function deselectAllUnits(){$(".unit-models").css({"box-shadow":"3px 3px 8px #222"})}
function rotateUnit(a){if(unitBeingRotated){var b=getUnitCenter(unitBeingRotated),a=Math.atan2(a.pageY-b[1],a.pageX-b[0])-mouseStartAngle+unitStartAngle;setRotationAngle(unitBeingRotated,a);return!1}}function setRotationAngle(a,b){performRotation(a,b);a.data("angle",b);return a}
function startRotate(a){unitBeingRotated=$(this).parent();var b=getUnitCenter(unitBeingRotated);mouseStartAngle=Math.atan2(a.pageY-b[1],a.pageX-b[0]);unitStartAngle=unitBeingRotated.data("angle");$(document).on("mousemove",rotateUnit);return!1}function stopRotate(){if(unitBeingRotated)return $(document).unbind("mousemove"),setTimeout(function(){unitBeingRotated=!1},10),!1}function dragStart(){if(unitBeingRotated)return!1}
function getUnitCenter(a){var b=getUnitOffset(a),c=b.left+a.width()/2,a=b.top+a.height()/2;return[c,a]}function getUnitOffset(a){performRotation(a,0);var b=a.offset();performRotation(a,a.data("angle"));return b}function performRotation(a,b){a.css("transform","rotate("+b+"rad)");a.css("-moz-transform","rotate("+b+"rad)");a.css("-webkit-transform","rotate("+b+"rad)");a.css("-o-transform","rotate("+b+"rad)")}
function dumpHTML(){var a=[];$(".artifact").each(function(){a.push(getDataFromElement($(this)))});$("#battlefield-out").val(btoa(JSON.stringify(a)))}
function getDataFromElement(a){var b=getUnitOffset(a),b={angle:a.data("angle"),baseHeight:a.data("baseHeight"),baseWidth:a.data("baseWidth"),files:a.data("files"),id:a.attr("id"),left:b.left,looseFormation:a.data("looseFormation"),player:a.data("player"),ranks:a.data("ranks"),title:a.data("title"),top:b.top,artifactType:a.data("artifactType")};a.hasClass("scenery")&&(b.src=a.data("src"),b.height=parseInt(a.css("height")),b.width=parseInt(a.css("width")),b.isScenery=a.data("isScenery"));return b}
function slurpHTML(){$("#battlefield").html("");for(var a=jQuery.parseJSON(atob($("#battlefield-out").val())),b=0;b<a.length;b++){var c=a[b],d;d="scenery"==c.artifactType?createScenery(c.id,c):createUnit(c.player,c.id,c);updateArtifactPosition(d,c)}}function updateArtifactPosition(a,b){a.offset({top:b.top,left:b.left});setRotationAngle(a,b.angle)}
function addModelsToUnit(a,b,c,d,e,g){for(var k=$(document.createElement("div")).addClass("unit-models").addClass("player-"+a.data("player")),f=Math.round(inchesToPx(0.5)),h=0;h<b;h++){for(var l=$(document.createElement("div")).css("clear","both"),i=0;i<c;i++){var j=$(document.createElement("div")).css({height:Math.round(mmToPx(e))-2+"px",width:Math.round(mmToPx(d))-2+"px",border:"1px solid #333","float":"left","background-color":"black"});g&&(0!=i&&j.css("margin-left",f+"px"),h<b-1&&j.css("margin-bottom",
f+"px"));j.appendTo(l)}l.appendTo(k)}d=Math.round(mmToPx(d))*c;g&&(d+=(c-1)*f);c=Math.round(mmToPx(e))*b;g&&(c+=(b-1)*f);k.css({width:d+"px",height:c+"px"}).appendTo(a)}function pxToMm(a){return 25.4*pxToInches(a)}function mmToPx(a){return inchesToPx(a/25.4)}function pxToInches(a){return a/16}function inchesToPx(a){return 16*a}function toNearestTenth(a){return Math.round(10*a)/10}function colorForPlayer(a){a=parseInt(a);return 1==a?"red":"blue"};
