var unitBeingRotated=!1,mouseStartAngle=!1,unitStartAngle=!1,battleUnits={"#player-1":[],"#player-2":[],"#scenery":[]},gameStarted=!1;
(function(a){a.fn.playable=function(){return this.each(function(){a(this).draggable({cancel:".handle"}).hover(function(){(!a(this).hasClass("scenery")||!gameStarted)&&a(this).children(".control").show()},function(){(!a(this).hasClass("scenery")||!gameStarted)&&a(this).children(".control").hide()}).rotatable().deletable()})};a.fn.rotatable=function(){return this.each(function(){a(this).data("angle",0);var b=a(document.createElement("div")).addClass("handle").addClass("control").draggable({opacity:0.01,
helper:"clone",start:dragStart}).hide().on("mousedown",startRotate).appendTo(a(this));addPlayerClass(a(this),b)})};a.fn.deletable=function(){var b=a(this),c=a(document.createElement("div")).data("unit",b.attr("id")).attr("title","Delete this?").addClass("dialog").dialog({resizable:!1,height:"40px",width:"160px",modal:!0,autoOpen:!1,buttons:{Delete:function(){a(this).dialog("close");var b=a(this).data("unit");removeFromBattle(b);a("#"+a(this).data("unit")).remove()},Cancel:function(){a(this).dialog("close")}}}),
d=a(document.createElement("div")).appendTo(b).addClass("delete-button").addClass("control").hide().on("click",function(){c.dialog("open");return!1});addPlayerClass(b,d)}})(jQuery);
$(function(){$(document).on("mouseup",stopRotate);$(".add-unit").on("click",addUnit);initializeSceneryManager();$("#control-panel").tabs({activate:function(a,b){$(".unit").draggable("disable");var c=b.newPanel.data("player");c?($(".unit").draggable("disable"),$(".unit.player-"+c).draggable("enable")):$(".unit").draggable("enable")}});$("#add-remote-scenery").on("click",loadRemoteScenery);$("#dump-button").on("click",dumpHTML);$("#slurp-button").on("click",slurpHTML);$("#start-game").on("click",toggleGameState)});
function addPlayerClass(a,b){var c=a.data("player");c&&b.addClass("player-"+c)}function toggleGameState(){gameStarted?(gameStarted=!1,$("#start-game").text("Start Game (locks scenery)"),$(".scenery").draggable({cancel:".handle"}).resizable({autoHide:!0,aspectRatio:!0})):(gameStarted=!0,$("#start-game").text("Stop Game (unlocks scenery)"),$(".scenery").draggable("destroy").resizable("destroy"))}
function initializeSceneryManager(){for(var a=["tower","wall","tree","corner_hill","hill"],b=0;b<a.length;b++)createSceneryButton("img/"+a[b]+".png",a[b].replace("_",""))}function loadRemoteScenery(){var a=$("#scenery-url").val(),b=$("#scenery-label").val();createSceneryButton(a,b)}
function createSceneryButton(a,b){$(document.createElement("img")).attr({src:a,alt:b}).load(function(){$(document.createElement("button")).appendTo($("#scenery-manager")).on("click",{src:this.src,height:this.height,width:this.width},addScenery).text(this.alt)})}
function addScenery(a){var b="scenery-"+battleUnits["#scenery"].length;battleUnits["#scenery"].push(b);a=$(document.createElement("div")).addClass("scenery").attr("id",b).css({height:a.data.height+"px",width:a.data.width+"px","z-index":10,"background-image":"url("+a.data.src+")","background-repeat":"none"}).resizable({autoHide:!0,aspectRatio:!0});$("#battlefield").append(a);a.playable()}
function addUnit(a){var a=a.target.parentElement.parentElement.dataset.player,b="#player-"+a,c="player-"+a+"-unit-"+battleUnits[b].length;battleUnits[b].push(c);var c=$(document.createElement("div")).attr("id",c).data("player",a).addClass("unit").addClass("player-"+a),d=$(document.createElement("div")).css("clear","both").addClass("unit-title").text($(b+"-unit-name").val());1==parseInt(a)&&d.appendTo(c);var e=$(b+"-unit-base-size").val().split("x"),f=$(b+"-unit-loose-formation").is(":checked");setUnitHeight(c,
parseInt($(b+"-unit-ranks").val()),parseInt($(b+"-unit-files").val()),e[0],e[1],f);2==parseInt(a)&&d.appendTo(c);$("#battlefield").append(c);c.playable()}function removeFromBattle(a){var b="#"+a.match(/player-\d|scenery/)[0];battleUnits[b].splice(battleUnits[b].indexOf(a))}
function rotateUnit(a){if(unitBeingRotated){var b=getUnitCenter(unitBeingRotated),a=Math.atan2(a.pageY-b[1],a.pageX-b[0])-mouseStartAngle+unitStartAngle;unitBeingRotated.css("transform","rotate("+a+"rad)");unitBeingRotated.css("-moz-transform","rotate("+a+"rad)");unitBeingRotated.css("-webkit-transform","rotate("+a+"rad)");unitBeingRotated.css("-o-transform","rotate("+a+"rad)");unitBeingRotated.data("angle",a);return!1}}
function startRotate(a){unitBeingRotated=$(this).parent();var b=getUnitCenter(unitBeingRotated);mouseStartAngle=Math.atan2(a.pageY-b[1],a.pageX-b[0]);unitStartAngle=unitBeingRotated.data("angle");$(document).on("mousemove",rotateUnit);return!1}function stopRotate(){if(unitBeingRotated)return $(document).unbind("mousemove"),setTimeout(function(){unitBeingRotated=!1},10),!1}function dragStart(){if(unitBeingRotated)return!1}
function getUnitCenter(a){a.css("transform","rotate(0rad)");a.css("-moz-transform","rotate(0rad)");a.css("-webkit-transform","rotate(0rad)");a.css("-o-transform","rotate(0rad)");var b=a.offset(),c=b.left+a.width()/2,b=b.top+a.height()/2,d=a.data("angle");a.css("transform","rotate("+d+"rad)");a.css("-moz-transform","rotate("+d+"rad)");a.css("-webkit-transform","rotate("+d+"rad)");a.css("-o-transform","rotate("+d+"rad)");return[c,b]}
function dumpHTML(){$("#battlefield-out").val($("#battlefield-bg").html())}function slurpHTML(){console.log("Slurping!");$("#battlefield-bg").html($("#battlefield-out").val());$(".unit").draggable()}
function setUnitHeight(a,b,c,d,e,f){for(var k=$(document.createElement("div")).addClass("unit-models").addClass("player-"+a.data("player")),g=Math.round(inchesToPx(0.5)),h=0;h<b;h++){for(var l=$(document.createElement("div")).css("clear","both"),i=0;i<c;i++){var j=$(document.createElement("div")).css({height:Math.round(mmToPx(e))-2+"px",width:Math.round(mmToPx(d))-2+"px",border:"1px solid #333","float":"left","background-color":"black"});f&&(0!=i&&j.css("margin-left",g+"px"),h<b-1&&j.css("margin-bottom",
g+"px"));j.appendTo(l)}l.appendTo(k)}d=Math.round(mmToPx(d))*c;f&&(d+=(c-1)*g);c=Math.round(mmToPx(e))*b;f&&(c+=(b-1)*g);k.css({width:d+"px",height:c+"px"}).appendTo(a)}function pxToMm(a){return 25.4*pxToInches(a)}function mmToPx(a){return inchesToPx(a/25.4)}function pxToInches(a){return a/16}function inchesToPx(a){return 16*a}function colorForPlayer(a){return 1==a?"red":"blue"}console.log("Loaded herald.js");
