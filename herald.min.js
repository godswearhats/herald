(function(){function s(){c=window.jQuery;c.getScript("http://code.jquery.com/ui/1.9.1/jquery-ui.min.js",function(){c.noConflict(!0);t("http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css");t(g+"herald.css");var a=c(document.createElement("div")).css("position","absolute");c.get(g+"control_panel.html",function(b){a.html(b);c("#battlefield").after(a);var d=c;d.fn.playable=function(){return this.each(function(){d(this).draggable({cancel:".handle"}).hover(function(){(!d(this).hasClass("lock")||
!j)&&d(this).children(".control").show()},function(){(!d(this).hasClass("lock")||!j)&&d(this).children(".control").hide()}).rotatable().deletable()})};d.fn.rotatable=function(){return this.each(function(){d(this).data("angle",0);var a=d(document.createElement("div")).addClass("handle").addClass("control").draggable({opacity:0.01,helper:"clone",start:H}).hide().on("mousedown",I).appendTo(d(this));u(d(this),a)})};d.fn.helpful=function(){return this.each(function(){var a=d(this).parent(),b=d(this).dialog({width:"400px",
autoOpen:!1,modal:!0,buttons:{Ok:function(){d(this).dialog("close")}}});d(document.createElement("span")).addClass("ui-icon ui-icon-help help-link").html("&nbsp;").on("click",function(){b.dialog("open");return!1}).prependTo(a);return b})};d.fn.deletable=function(){var a=d(this),b=d(document.createElement("div")).data("unit",a.attr("id")).attr("title","Delete this?").addClass("dialog").dialog({resizable:!1,height:"40px",width:"160px",modal:!0,autoOpen:!1,buttons:{Delete:function(){d(this).dialog("close");
d(this).data("unit");d("#"+d(this).data("unit")).remove()},Cancel:function(){d(this).dialog("close")}}}),c=d(document.createElement("div")).appendTo(a).addClass("delete-button").addClass("control").hide().on("click",function(){b.dialog("open");return!1});u(a,c);return a};c(document).on("mouseup",J);c(".add-unit").on("click",K);c(".update-unit").on("click",L);c("#add-remote-scenery").on("click",M);c("#dump-button").on("click",N);c("#load-button").on("click",O);c("#slurp-button").on("click",P);c("#save-button").on("click",
Q);c("#start-report").on("click",R);c(".rank-and-file").on("change",{callback:S},v);c(".model-count").on("change",{callback:T},v);c("#advanced-link").on("click",function(){c("#advanced").toggle("blind");return!1});l(1);l(2);for(var b=["tower","wall","tree","corner_hill","hill"],e=0;e<b.length;e++)h(g+"img/"+b[e]+".png",b[e].replace("_"," "),{controlPanelID:"#scenery-manager",aspectRatio:!0,isResizable:!0,lock:!0});h(g+"img/red_arrow.png","Player 1",{controlPanelID:"#report",aspectRatio:!1,measure:!0,
isResizable:!0});h(g+"img/blue_arrow.png","Player 2",{controlPanelID:"#report",aspectRatio:!1,measure:!0,isResizable:!0});h(g+"img/skull.png","Kill",{controlPanelID:"#report",aspectRatio:!1,isResizable:!0});h(g+"img/small_blast.png","Blast",{controlPanelID:"#report",aspectRatio:!1,isResizable:!1});h(g+"img/large_blast.png","Large Blast",{controlPanelID:"#report",aspectRatio:!1,isResizable:!1});h(g+"img/flame_template.png","Template",{controlPanelID:"#report",aspectRatio:!1,isResizable:!1});c("#control-panel").tabs({activate:U,
collapsible:!0,active:!1}).draggable();c(".help").helpful();var f=null;c("script").each(function(){if(!this.src)return null;var a=this.src.match(/herald(\.min)?\.js\?report=([A-Za-z0-9]+)/);a&&(f=a[2])});if(!(b=f))b=/[\?&]report=([^&#]*)/.exec(window.location.search),b=null==b?void 0:decodeURIComponent(b[1].replace(/\+/g," "));b&&c.getJSON(g+"reports/"+b+".json",m);c("#report-id").val(b)})})}function t(a){c(document.createElement("link")).attr({rel:"stylesheet",href:a}).appendTo("head")}function U(a,
b){c(".unit").draggable("disable");var d=b.newPanel.data("player");d?(c(".unit").draggable("disable"),c(".unit.player-"+d).draggable("enable")):(c(".unit").draggable("enable"),"collapse"==b.newPanel.attr("id")&&c("#control-panel").tabs("option","active",!1))}function R(){j?(j=!1,c("#start-report").text("Start Report (locks scenery)"),c(".scenery").draggable({cancel:".handle"}),c(".resizable-scenery").each(function(){$(this).resizable({autoHide:!0,aspectRatio:$(this).data("aspectRatio")})}),c(".add-unit").prop("disabled",
!1),c(".dead-count").prop("disabled",!0)):(j=!0,c("#start-report").text("Stop Report (unlocks scenery)"),c(".scenery").draggable("destroy"),c(".resizable-scenery").resizable("destroy"),c(".add-unit").prop("disabled",!0),c(".dead-count").prop("disabled",!1))}function M(){var a=c("#scenery-url").val(),b=c("#scenery-label").val();h(a,b,{controlPanelID:"#scenery-manager",aspectRatio:!0})}function h(a,b,d){c(document.createElement("img")).attr({src:a,alt:b}).data(d).load(function(){c(document.createElement("button")).appendTo(d.controlPanelID).on("click",
c.extend({},d,{src:this.src,height:this.height,width:this.width}),V).text(this.alt)})}function V(a){var b="scenery-unit-"+i(".scenery");a.data.artifactType="scenery";w(b,a.data)}function w(a,b){var d=c(document.createElement("div")).addClass("scenery").addClass("artifact").attr("id",a).data(b).css({height:b.height+"px",width:b.width+"px","z-index":b.lock?10:50,"background-image":"url("+b.src+")","background-repeat":"none"});b.isResizable&&(d.resizable({autoHide:!0,aspectRatio:b.aspectRatio}),d.addClass("resizable-scenery"));
if(b.measure){var e=b.height;d.on("resize",function(a,b){b.element.children(".scenery-size").show().text(Math.round(10*(b.size.height/16))/10+"in.")});c(document.createElement("div")).text(Math.round(10*(e/16))/10+"in.").addClass("scenery-size").addClass("control").hide().appendTo(d)}b.lock&&d.addClass("lock");c("#battlefield").append(d);d.playable();d.offset({top:c("#battlefield").height()/2-d.height()/2,left:c("#battlefield").width()/2-d.width()/2});return d}function K(a){var a=parseInt(a.target.dataset.player),
b="player-"+a+"-unit-"+i(".player-"+a),c=x(a,{artifactType:"unit"});p(a,b,c);l(a)}function x(a,b){var d="#player-"+a+"-unit-",e=c(d+"base-size").val().split("x");b.baseWidth=e[0];b.baseHeight=e[1];b.looseFormation=c(d+"loose-formation").is(":checked");b.ranks=parseInt(c(d+"ranks").val());b.files=parseInt(c(d+"files").val());b.models=parseInt(c(d+"models").val());b.modelsDead=parseInt(c(d+"models-dead").val());0==b.models&&(b.models=b.files*b.ranks);b.title=c(d+"title").val();return b}function i(a){var b=
0;c(".artifact"+a).each(function(){var a=parseInt(c(this).attr("id").split("-").pop());a>b&&(b=a)});return b+1}function p(a,b,d){var e=c(document.createElement("div")).attr("id",b).data(d).data("player",a).addClass("unit").addClass("artifact").addClass("player-"+a),f=c(document.createElement("div")).css("clear","both").addClass("unit-title").text(d.title);1==parseInt(a)&&f.appendTo(e);for(var g=c(document.createElement("div")).addClass("unit-models").addClass("player-"+e.data("player")),h=0,j=d.models-
d.modelsDead,n=[],i=0;i<d.ranks;i++){n[i]=[];for(var k=0;k<d.files&&h!=d.models;k++){var l=c(document.createElement("div")).css({height:Math.round(16*(d.baseHeight/25.4))-2+"px",width:Math.round(16*(d.baseWidth/25.4))-2+"px",border:"1px solid #333","float":"left","background-color":h>=j?"gray":"black"});n[i].push(l);h++}}1==parseInt(a)&&n.unshift(n.pop());var m=1==parseInt(a)?"margin-top":"margin-bottom";c.each(n,function(b,e){var f=c(document.createElement("div")).css("clear","both");c.each(e,function(c,
e){d.looseFormation&&(0!=c&&e.css("margin-left",q+"px"),(1==parseInt(a)?0==b:b+1==d.ranks)||e.css(m,q+"px"));e.appendTo(f)});f.appendTo(g)});g.css({width:y(d.baseWidth,d.files,d.looseFormation)+"px",height:y(d.baseHeight,d.ranks,d.looseFormation)+"px"}).appendTo(e);2==parseInt(a)&&f.appendTo(e);c("#battlefield").append(e);e.playable();e.on("click",{unitID:b},W);e.offset({top:1==a?10:c("#battlefield").height()-e.height()-10,left:c("#battlefield").width()/2-e.width()/2});return e}function y(a,b,c){a=
Math.round(16*(a/25.4))*b;c&&(a+=(b-1)*q);return a}function L(a){var b=c("#"+c(a.target).data("unit")),a=b.data();void 0===a.top&&(a.top=b.offset().top,a.left=b.offset().left);var d=b.attr("id");b.remove();b=p(a.player,d,x(a.player,a));z(b,a)}function l(a){A(a,{ranks:"",files:"",models:"",modelsDead:0,title:"",baseHeight:20,baseWidth:20,looseFormation:!1});c("#unit-manager-player-"+a+" .update-unit").prop("disabled",!0)}function W(a){var a=c("#"+a.data.unitID),b=a.children(".unit-models");c(".unit-models").css({"box-shadow":"3px 3px 8px #222"});
b.css({"box-shadow":"8px 8px 20px #000"});b=parseInt(a.data("player"));c("#control-panel").tabs("select",b);A(b,a.data());c("#unit-manager-player-"+b+" .update-unit").prop("disabled",!1).data("unit",a.attr("id"))}function A(a,b){var d="#player-"+a+"-unit-";c(d+"ranks").val(b.ranks);c(d+"files").val(b.files);c(d+"models").val(b.models);c(d+"models-dead").val(b.modelsDead);c(d+"title").val(b.title);c(d+'base-size option[value="'+b.baseHeight+"x"+b.baseWidth+'"]').prop("selected",!0);c(d+"loose-formation").prop("checked",
b.looseFormation)}function u(a,b){var c=a.data("player");c&&b.addClass("player-"+c)}function v(a){var b="#"+a.target.id.match(/player-\d+-unit-/).pop(),d=parseInt(c(b+"ranks").val())||1,e=parseInt(c(b+"files").val())||1;a.data.callback(b,(d-1)*e+1,d*e)}function S(a,b,d){c(a+"model-count").text(b+"-"+d);c(a+"models").val(d)}function T(a,b,d){var e=c(a+"models").val();e<b?e=b:e>d&&(e=d);c(a+"models").val(e)}function X(a){if(f){var b=B(f),a=Math.atan2(a.pageY-b[1],a.pageX-b[0])-C+D;E(f,a);return!1}}
function E(a,b){r(a,b);a.data("angle",b);return a}function I(a){f=c(this).parent();var b=B(f);C=Math.atan2(a.pageY-b[1],a.pageX-b[0]);D=f.data("angle");c(document).on("mousemove",X);return!1}function J(){if(f)return c(document).unbind("mousemove"),setTimeout(function(){f=!1},10),!1}function H(){if(f)return!1}function B(a){var b=F(a),c=b.left+a.width()/2,a=b.top+a.height()/2;return[c,a]}function F(a){r(a,0);var b=a.offset();r(a,a.data("angle"));return b}function r(a,b){a.css("transform","rotate("+
b+"rad)");a.css("-moz-transform","rotate("+b+"rad)");a.css("-webkit-transform","rotate("+b+"rad)");a.css("-o-transform","rotate("+b+"rad)")}function N(){var a=G();c("#battlefield-out").val(a)}function G(){var a=[];c(".artifact").each(function(){a.push(Y(c(this)))});return JSON.stringify(a)}function Q(){var a=G();c.post("report.php",{id:c("#report-id").val(),data:a},function(a){response=c.parseJSON(a);c(document.createElement("div")).dialog({modal:!0,buttons:{Ok:function(){c(this).dialog("close")}}}).html(response.message);
response.id&&c("#report-id").val(response.id)})}function O(){console.log("Loading report from server");!1==c("#merge").prop("checked")&&(console.log("Merge false"),c("#battlefield").html(""));c.getJSON("reports/"+c("#report-id").val()+".json",m)}function Y(a){var b=F(a),b={angle:a.data("angle"),baseHeight:a.data("baseHeight"),baseWidth:a.data("baseWidth"),files:a.data("files"),id:a.attr("id"),left:b.left,looseFormation:a.data("looseFormation"),models:a.data("models"),modelsDead:a.data("modelsDead"),
player:a.data("player"),ranks:a.data("ranks"),title:a.data("title"),top:b.top,artifactType:a.data("artifactType")};a.hasClass("scenery")&&(b.src=a.data("src"),b.height=parseInt(a.css("height")),b.width=parseInt(a.css("width")),b.aspectRatio=a.data("aspectRatio"),b.isResizable=a.data("isResizable"),b.measure=a.data("measure"),b.lock=a.data("lock"));return b}function P(){!1==c("#merge").prop("checked")&&c("#battlefield").html("");var a=c.parseJSON(c("#battlefield-out").val());m(a)}function m(a){for(var b=
0;b<a.length;b++){var c=a[b],e;"scenery"==c.artifactType?(e="scenery-unit-"+i(".scenery"),e=w(e,c)):(e="player-"+c.player+"-unit-"+i(".player-"+c.player),e=p(c.player,e,c));z(e,c)}}function z(a,b){a.offset({top:b.top,left:b.left});E(a,b.angle)}var c,f=!1,C=!1,D=!1,j=!1,q=Math.round(8),g=window.BASE_URL||"http://godswearhats.com/herald/";if(void 0===window.jQuery||"1.8.2"!==window.jQuery.fn.jquery){var k=document.createElement("script");k.setAttribute("type","text/javascript");k.setAttribute("src",
"http://code.jquery.com/jquery-1.8.2.min.js");(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(k);k.onload=s}else s()})();
