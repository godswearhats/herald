var artifactBeingRotated=!1,mouseStartAngle=!1,artifactStartAngle=!1,reportStarted=!1,LOOSE_FORMATION_GAP=Math.round(inchesToPx(0.5));
(function(a){a.fn.playable=function(){return this.each(function(){a(this).draggable({cancel:".handle"}).hover(function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").show()},function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").hide()}).rotatable().deletable()})};a.fn.rotatable=function(){return this.each(function(){a(this).data("angle",0);var b=a(document.createElement("div")).addClass("handle").addClass("control").draggable({opacity:0.01,
helper:"clone",start:dragStart}).hide().on("mousedown",startRotate).appendTo(a(this));addPlayerClass(a(this),b)})};a.fn.helpful=function(){var b=a(this).parent(),c=a(this).dialog({autoOpen:!1,modal:!0,buttons:{Ok:function(){a(this).dialog("close")}}});a(document.createElement("span")).addClass("ui-icon ui-icon-help help-link").html("&nbsp;").on("click",function(){c.dialog("open");return!1}).prependTo(b);return c};a.fn.deletable=function(){var b=a(this),c=a(document.createElement("div")).data("unit",
b.attr("id")).attr("title","Delete this?").addClass("dialog").dialog({resizable:!1,height:"40px",width:"160px",modal:!0,autoOpen:!1,buttons:{Delete:function(){a(this).dialog("close");a(this).data("unit");a("#"+a(this).data("unit")).remove()},Cancel:function(){a(this).dialog("close")}}}),d=a(document.createElement("div")).appendTo(b).addClass("delete-button").addClass("control").hide().on("click",function(){c.dialog("open");return!1});addPlayerClass(b,d);return b}})(jQuery);
$(function(){$(document).on("mouseup",stopRotate);$(".add-unit").on("click",addUnit);$(".update-unit").on("click",updateUnit);$("#add-remote-scenery").on("click",loadRemoteScenery);$("#dump-button").on("click",dumpHTML);$("#load-button").on("click",function(){$.getJSON("reports/"+$("#report-id").val()+".json",loadReportFromJSON)});$("#slurp-button").on("click",slurpHTML);$("#save-button").on("click",saveReportToServer);$("#start-report").on("click",toggleReportState);$(".rank-and-file").on("change",
{callback:updateModelCount},modelCountHandler);$(".model-count").on("change",{callback:validateModelCount},modelCountHandler);$("#advanced-link").on("click",function(){$("#advanced").toggle("blind");return!1});resetUnitManagerInfo(1);resetUnitManagerInfo(2);for(var a=["tower","wall","tree","corner_hill","hill"],b=0;b<a.length;b++)createSceneryButton("img/"+a[b]+".png",a[b].replace("_"," "),!0,"#scenery-manager");createSceneryButton("img/red_arrow.png","Player 1",!1,"#report");createSceneryButton("img/blue_arrow.png",
"Player 2",!1,"#report");$("#control-panel").tabs({activate:function(a,b){$(".unit").draggable("disable");var e=b.newPanel.data("player");e?($(".unit").draggable("disable"),$(".unit.player-"+e).draggable("enable")):($(".unit").draggable("enable"),"collapse"==b.newPanel.attr("id")&&$("#control-panel").tabs("option","active",!1))},collapsible:!0}).draggable();$(".help").helpful();a="report".replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(window.location.search);(a=
null==a?void 0:decodeURIComponent(a[1].replace(/\+/g," ")))&&$.getJSON("reports/"+a+".json",loadReportFromJSON);$("#report-id").val(a)});
function toggleReportState(){reportStarted?(reportStarted=!1,$("#start-report").text("Start Report (locks scenery)"),$(".scenery").draggable({cancel:".handle"}).resizable({autoHide:!0,aspectRatio:!0}),$(".add-unit").prop("disabled",!1),$(".dead-count").prop("disabled",!0)):(reportStarted=!0,$("#start-report").text("Stop Report (unlocks scenery)"),$(".scenery").draggable("destroy").resizable("destroy"),$(".add-unit").prop("disabled",!0),$(".dead-count").prop("disabled",!1))}
function loadRemoteScenery(){var a=$("#scenery-url").val(),b=$("#scenery-label").val();createSceneryButton(a,b,!0,"#scenery-manager")}function createSceneryButton(a,b,c,d){$(document.createElement("img")).attr({src:a,alt:b}).data({isScenery:c,controlPanelID:d}).load(function(){$(document.createElement("button")).appendTo($(d)).on("click",{src:this.src,height:this.height,width:this.width,isScenery:c},addScenery).text(this.alt)})}
function addScenery(a){var b="scenery-unit-"+getNextID(".scenery");createScenery(b,{artifactType:"scenery",height:a.data.height,width:a.data.width,src:a.data.src,isScenery:a.data.isScenery})}
function createScenery(a,b){var c=$(document.createElement("div")).addClass("scenery").addClass("artifact").attr("id",a).data(b).css({height:b.height+"px",width:b.width+"px","z-index":10,"background-image":"url("+b.src+")","background-repeat":"none"}).resizable({autoHide:!0,aspectRatio:b.isScenery});b.isScenery||addMeasurementHooks(c,b.height);$("#battlefield").append(c);c.playable();return c}
function addMeasurementHooks(a,b){a.on("resize",function(a,b){b.element.children(".scenery-size").show().text(toNearestTenth(pxToInches(b.size.height))+"in.")});$(document.createElement("div")).text(toNearestTenth(pxToInches(b))+"in.").addClass("scenery-size").addClass("control").hide().appendTo(a);return a}
function addUnit(a){var a=parseInt(a.target.dataset.player),b="player-"+a+"-unit-"+getNextID(".player-"+a),c=initializeUnitData(a,{artifactType:"unit"});createUnit(a,b,c);resetUnitManagerInfo(a)}
function initializeUnitData(a,b){var c="#player-"+a+"-unit-",d=$(c+"base-size").val().split("x");b.baseWidth=d[0];b.baseHeight=d[1];b.looseFormation=$(c+"loose-formation").is(":checked");b.ranks=parseInt($(c+"ranks").val());b.files=parseInt($(c+"files").val());b.models=parseInt($(c+"models").val());b.modelsDead=parseInt($(c+"models-dead").val());0==b.models&&(b.models=b.files*b.ranks);b.title=$(c+"title").val();return b}
function getNextID(a){var b=0;$(".artifact"+a).each(function(){var a=parseInt($(this).attr("id").split("-").pop());a>b&&(b=a)});return b+1}
function createUnit(a,b,c){var d=$(document.createElement("div")).attr("id",b).data(c).data("player",a).addClass("unit").addClass("artifact").addClass("player-"+a),e=$(document.createElement("div")).css("clear","both").addClass("unit-title").text(c.title);1==parseInt(a)&&e.appendTo(d);addModelsToUnit(a,d,c);2==parseInt(a)&&e.appendTo(d);$("#battlefield").append(d);d.playable();d.on("click",{unitID:b},highlightUnit);return d}
function addModelsToUnit(a,b,c){var d=$(document.createElement("div")).addClass("unit-models").addClass("player-"+b.data("player")),e=createUnitArray(a,b,c),f=playerUnitsFaceSouth(a)?"margin-top":"margin-bottom";$.each(e,function(b,e){var h=$(document.createElement("div")).css("clear","both");$.each(e,function(d,e){c.looseFormation&&(0!=d&&e.css("margin-left",LOOSE_FORMATION_GAP+"px"),isLastRankForPlayer(a,b,c.ranks)||e.css(f,LOOSE_FORMATION_GAP+"px"));e.appendTo(h)});h.appendTo(d)});d.css({width:calculateUnitDimension(c.baseWidth,
c.files,c.looseFormation)+"px",height:calculateUnitDimension(c.baseHeight,c.ranks,c.looseFormation)+"px"}).appendTo(b)}function createUnitArray(a,b,c){for(var b=0,d=c.models-c.modelsDead,e=[],f=0;f<c.ranks;f++){e[f]=[];for(var g=0;g<c.files&&b!=c.models;g++){var i=createNewModel(c.baseWidth,c.baseHeight,b>=d);e[f].push(i);b++}}playerUnitsFaceSouth(a)&&e.unshift(e.pop());return e}
function createNewModel(a,b,c){return $(document.createElement("div")).css({height:Math.round(mmToPx(b))-2+"px",width:Math.round(mmToPx(a))-2+"px",border:"1px solid #333","float":"left","background-color":c?"gray":"black"})}function isLastRankForPlayer(a,b,c){return playerUnitsFaceSouth(a)?0==b:b+1==c}function playerUnitsFaceSouth(a){return 1==parseInt(a)}function calculateUnitDimension(a,b,c){a=Math.round(mmToPx(a))*b;c&&(a+=(b-1)*LOOSE_FORMATION_GAP);return a}
function updateUnit(a){var b=$("#"+$(a.target).data("unit")),a=b.data();void 0===a.top&&(a.top=b.offset().top,a.left=b.offset().left);var c=b.attr("id");b.remove();b=createUnit(a.player,c,initializeUnitData(a.player,a));updateArtifactPosition(b,a)}function resetUnitManagerInfo(a){setUnitManagerInfo(a,defaultUnitData());$("#unit-manager-player-"+a+" .update-unit").prop("disabled",!0)}
function highlightUnit(a){var b=$("#"+a.data.unitID),c=b.children(".unit-models");deselectAllUnits(a);c.css({"box-shadow":"8px 8px 20px #000"});displayUnitInfo(b)}function displayUnitInfo(a){var b=parseInt(a.data("player"));$("#control-panel").tabs("select",b);setUnitManagerInfo(b,a.data());$("#unit-manager-player-"+b+" .update-unit").prop("disabled",!1).data("unit",a.attr("id"))}
function setUnitManagerInfo(a,b){var c="#player-"+a+"-unit-";$(c+"ranks").val(b.ranks);$(c+"files").val(b.files);$(c+"models").val(b.models);$(c+"models-dead").val(b.modelsDead);$(c+"title").val(b.title);$(c+'base-size option[value="'+b.baseHeight+"x"+b.baseWidth+'"]').prop("selected",!0);$(c+"loose-formation").prop("checked",b.looseFormation)}function defaultUnitData(){return{ranks:"",files:"",models:"",modelsDead:0,title:"",baseHeight:20,baseWidth:20,looseFormation:!1}}
function deselectAllUnits(){$(".unit-models").css({"box-shadow":"3px 3px 8px #222"})}function addPlayerClass(a,b){var c=a.data("player");c&&b.addClass("player-"+c)}function modelCountHandler(a){var b="#"+a.target.id.match(/player-\d+-unit-/).pop(),c=parseInt($(b+"ranks").val())||1,d=parseInt($(b+"files").val())||1;a.data.callback(b,(c-1)*d+1,c*d)}function updateModelCount(a,b,c){$(a+"model-count").text(b+"-"+c);$(a+"models").val(c)}
function validateModelCount(a,b,c){var d=$(a+"models").val();d<b?d=b:d>c&&(d=c);$(a+"models").val(d)}function rotateArtifact(a){if(artifactBeingRotated){var b=getArtifactCenter(artifactBeingRotated),a=Math.atan2(a.pageY-b[1],a.pageX-b[0])-mouseStartAngle+artifactStartAngle;setRotationAngle(artifactBeingRotated,a);return!1}}function setRotationAngle(a,b){performRotation(a,b);a.data("angle",b);return a}
function startRotate(a){artifactBeingRotated=$(this).parent();var b=getArtifactCenter(artifactBeingRotated);mouseStartAngle=Math.atan2(a.pageY-b[1],a.pageX-b[0]);artifactStartAngle=artifactBeingRotated.data("angle");$(document).on("mousemove",rotateArtifact);return!1}function stopRotate(){if(artifactBeingRotated)return $(document).unbind("mousemove"),setTimeout(function(){artifactBeingRotated=!1},10),!1}function dragStart(){if(artifactBeingRotated)return!1}
function getArtifactCenter(a){var b=getArtifactOffset(a),c=b.left+a.width()/2,a=b.top+a.height()/2;return[c,a]}function getArtifactOffset(a){performRotation(a,0);var b=a.offset();performRotation(a,a.data("angle"));return b}function performRotation(a,b){a.css("transform","rotate("+b+"rad)");a.css("-moz-transform","rotate("+b+"rad)");a.css("-webkit-transform","rotate("+b+"rad)");a.css("-o-transform","rotate("+b+"rad)")}function dumpHTML(){var a=stringifyArtifacts();$("#battlefield-out").val(a)}
function stringifyArtifacts(){var a=[];$(".artifact").each(function(){a.push(getDataFromElement($(this)))});return JSON.stringify(a)}function saveReportToServer(){var a=stringifyArtifacts();$.post("report.php",{id:$("#report-id").val(),data:a},function(a){response=jQuery.parseJSON(a);$(document.createElement("div")).dialog({modal:!0,buttons:{Ok:function(){$(this).dialog("close")}}}).html(response.message);response.id&&$("#report-id").val(response.id)})}
function getDataFromElement(a){var b=getArtifactOffset(a),b={angle:a.data("angle"),baseHeight:a.data("baseHeight"),baseWidth:a.data("baseWidth"),files:a.data("files"),id:a.attr("id"),left:b.left,looseFormation:a.data("looseFormation"),models:a.data("models"),modelsDead:a.data("modelsDead"),player:a.data("player"),ranks:a.data("ranks"),title:a.data("title"),top:b.top,artifactType:a.data("artifactType")};a.hasClass("scenery")&&(b.src=a.data("src"),b.height=parseInt(a.css("height")),b.width=parseInt(a.css("width")),
b.isScenery=a.data("isScenery"));return b}function slurpHTML(){!1==$("#merge").prop("checked")&&$("#battlefield").html("");var a=jQuery.parseJSON($("#battlefield-out").val());loadReportFromJSON(a)}function loadReportFromJSON(a){for(var b=0;b<a.length;b++){var c=a[b],d;"scenery"==c.artifactType?(d="scenery-unit-"+getNextID(".scenery"),d=createScenery(d,c)):(d="player-"+c.player+"-unit-"+getNextID(".player-"+c.player),d=createUnit(c.player,d,c));updateArtifactPosition(d,c)}}
function updateArtifactPosition(a,b){a.offset({top:b.top,left:b.left});setRotationAngle(a,b.angle)}function pxToMm(a){return 25.4*pxToInches(a)}function mmToPx(a){return inchesToPx(a/25.4)}function pxToInches(a){return a/16}function inchesToPx(a){return 16*a}function toNearestTenth(a){return Math.round(10*a)/10}function colorForPlayer(a){a=parseInt(a);return 1==a?"red":"blue"};
