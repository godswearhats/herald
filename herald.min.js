var unitBeingRotated=!1,mouseStartAngle=!1,unitStartAngle=!1,battleUnits={"#player-1":[],"#player-2":[],"#scenery":[]},reportStarted=!1;
(function(a){a.fn.playable=function(){return this.each(function(){a(this).draggable({cancel:".handle"}).hover(function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").show()},function(){(!a(this).hasClass("scenery")||!reportStarted)&&a(this).children(".control").hide()}).rotatable().deletable()})};a.fn.rotatable=function(){return this.each(function(){a(this).data("angle",0);var b=a(document.createElement("div")).addClass("handle").addClass("control").draggable({opacity:0.01,
helper:"clone",start:dragStart}).hide().on("mousedown",startRotate).appendTo(a(this));addPlayerClass(a(this),b)})};a.fn.deletable=function(){var b=a(this),c=a(document.createElement("div")).data("unit",b.attr("id")).attr("title","Delete this?").addClass("dialog").dialog({resizable:!1,height:"40px",width:"160px",modal:!0,autoOpen:!1,buttons:{Delete:function(){a(this).dialog("close");var b=a(this).data("unit");removeFromBattle(b);a("#"+a(this).data("unit")).remove()},Cancel:function(){a(this).dialog("close")}}}),
e=a(document.createElement("div")).appendTo(b).addClass("delete-button").addClass("control").hide().on("click",function(){c.dialog("open");return!1});addPlayerClass(b,e)}})(jQuery);
$(function(){$(document).on("mouseup",stopRotate);$(".add-unit").on("click",addUnit);initializeSceneryManager();$("#control-panel").tabs({activate:function(a,b){$(".unit").draggable("disable");var c=b.newPanel.data("player");c?($(".unit").draggable("disable"),$(".unit.player-"+c).draggable("enable")):$(".unit").draggable("enable")}});$("#add-remote-scenery").on("click",loadRemoteScenery);$("#dump-button").on("click",dumpHTML);$("#slurp-button").on("click",slurpHTML);$("#start-game").on("click",toggleGameState)});
function addPlayerClass(a,b){var c=a.data("player");c&&b.addClass("player-"+c)}function toggleGameState(){reportStarted?(reportStarted=!1,$("#start-game").text("Start Report (locks scenery)"),$(".scenery").draggable({cancel:".handle"}).resizable({autoHide:!0,aspectRatio:!0})):(reportStarted=!0,$("#start-game").text("Stop Report (unlocks scenery)"),$(".scenery").draggable("destroy").resizable("destroy"))}
function initializeSceneryManager(){for(var a=["tower","wall","tree","corner_hill","hill"],b=0;b<a.length;b++)createSceneryButton("img/"+a[b]+".png",a[b].replace("_"," "),!0,"#scenery-manager");createSceneryButton("img/red_arrow.png","Player 1",!1,"#game");createSceneryButton("img/blue_arrow.png","Player 2",!1,"#game")}function loadRemoteScenery(){var a=$("#scenery-url").val(),b=$("#scenery-label").val();createSceneryButton(a,b,!0,"#scenery-manager")}
function createSceneryButton(a,b,c,e){$(document.createElement("img")).attr({src:a,alt:b}).data({isScenery:c,controlPanelID:e}).load(function(){$(document.createElement("button")).appendTo($(e)).on("click",{src:this.src,height:this.height,width:this.width,isScenery:c},addScenery).text(this.alt)})}function addScenery(a){createScenery("scenery-unit-"+battleUnits["#scenery"].length,{height:a.data.height,width:a.data.width,src:a.data.src,isScenery:a.data.isScenery})}
function createScenery(a,b){battleUnits["#scenery"].push(a);var c=$(document.createElement("div")).addClass("scenery").attr("id",a).data(b).css({height:b.height+"px",width:b.width+"px","z-index":10,"background-image":"url("+b.src+")","background-repeat":"none"}).resizable({autoHide:!0,aspectRatio:b.isScenery});b.isScenery||addMeasurementHooks(c,b.height);$("#battlefield").append(c);c.playable();return c}
function addMeasurementHooks(a,b){a.on("resize",function(a,b){b.element.children(".scenery-size").show().text(toNearestTenth(pxToInches(b.size.height))+"in.")});$(document.createElement("div")).text(toNearestTenth(pxToInches(b))+"in.").addClass("scenery-size").addClass("control").hide().appendTo(a);return a}
function addUnit(a){var a=parseInt(a.target.parentElement.parentElement.dataset.player),b="#player-"+a,c="player-"+a+"-unit-"+battleUnits[b].length,e={},f=$(b+"-unit-base-size").val().split("x");e.baseWidth=f[0];e.baseHeight=f[1];e.looseFormation=$(b+"-unit-loose-formation").is(":checked");e.ranks=parseInt($(b+"-unit-ranks").val());e.files=parseInt($(b+"-unit-files").val());e.title=$(b+"-unit-name").val();createUnit(a,c,e)}
function createUnit(a,b,c){battleUnits["#player-"+a].push(b);var b=$(document.createElement("div")).attr("id",b).data(c).data("player",a).addClass("unit").addClass("player-"+a),e=$(document.createElement("div")).css("clear","both").addClass("unit-title").text(c.title);1==a&&e.appendTo(b);setUnitHeight(b,c.ranks,c.files,c.baseWidth,c.baseHeight,c.looseFormation);2==parseInt(a)&&e.appendTo(b);$("#battlefield").append(b);b.playable();return b}
function removeFromBattle(a){var b="#"+a.match(/player-\d|scenery/)[0];battleUnits[b].splice(battleUnits[b].indexOf(a))}function rotateUnit(a){if(unitBeingRotated){var b=getUnitCenter(unitBeingRotated),a=Math.atan2(a.pageY-b[1],a.pageX-b[0])-mouseStartAngle+unitStartAngle;setRotationAngle(unitBeingRotated,a);return!1}}function setRotationAngle(a,b){performRotation(a,b);a.data("angle",b);return a}
function startRotate(a){unitBeingRotated=$(this).parent();var b=getUnitCenter(unitBeingRotated);mouseStartAngle=Math.atan2(a.pageY-b[1],a.pageX-b[0]);unitStartAngle=unitBeingRotated.data("angle");$(document).on("mousemove",rotateUnit);return!1}function stopRotate(){if(unitBeingRotated)return $(document).unbind("mousemove"),setTimeout(function(){unitBeingRotated=!1},10),!1}function dragStart(){if(unitBeingRotated)return!1}
function getUnitCenter(a){var b=getUnitOffset(a),c=b.left+a.width()/2,a=b.top+a.height()/2;return[c,a]}function getUnitOffset(a){performRotation(a,0);var b=a.offset();performRotation(a,a.data("angle"));return b}function performRotation(a,b){a.css("transform","rotate("+b+"rad)");a.css("-moz-transform","rotate("+b+"rad)");a.css("-webkit-transform","rotate("+b+"rad)");a.css("-o-transform","rotate("+b+"rad)")}
function dumpHTML(){for(var a={},b=["#player-1","#player-2","#scenery"],c=0;c<b.length;c++){label=b[c];a[label]=[];for(var e=0;e<battleUnits[label].length;e++){var f=$(label+"-unit-"+e);a[label].push(getDataFromElement(f))}}$("#battlefield-out").val(btoa(JSON.stringify(a)))}
function getDataFromElement(a){var b=getUnitOffset(a),b={angle:a.data("angle"),baseHeight:a.data("baseHeight"),baseWidth:a.data("baseWidth"),files:a.data("files"),id:a.attr("id"),left:b.left,looseFormation:a.data("looseFormation"),player:a.data("player"),ranks:a.data("ranks"),title:a.data("title"),top:b.top};a.hasClass("scenery")&&(b.src=a.data("src"),b.height=parseInt(a.css("height")),b.width=parseInt(a.css("width")),b.isScenery=a.data("isScenery"));return b}
function slurpHTML(){battleUnits={"#player-1":[],"#player-2":[],"#scenery":[]};$("#battlefield").html("");for(var a=jQuery.parseJSON(atob($("#battlefield-out").val())),b=["#player-1","#player-2","#scenery"],c=0;c<b.length;c++){label=b[c];for(var e=0;e<a[label].length;e++){var f=a[label][e],d;d="#scenery"==label?createScenery(f.id,f):createUnit(f.player,f.id,f);d.offset({top:f.top,left:f.left});setRotationAngle(d,f.angle)}}}
function setUnitHeight(a,b,c,e,f,d){for(var g=$(document.createElement("div")).addClass("unit-models").addClass("player-"+a.data("player")),h=Math.round(inchesToPx(0.5)),i=0;i<b;i++){for(var l=$(document.createElement("div")).css("clear","both"),j=0;j<c;j++){var k=$(document.createElement("div")).css({height:Math.round(mmToPx(f))-2+"px",width:Math.round(mmToPx(e))-2+"px",border:"1px solid #333","float":"left","background-color":"black"});d&&(0!=j&&k.css("margin-left",h+"px"),i<b-1&&k.css("margin-bottom",
h+"px"));k.appendTo(l)}l.appendTo(g)}e=Math.round(mmToPx(e))*c;d&&(e+=(c-1)*h);c=Math.round(mmToPx(f))*b;d&&(c+=(b-1)*h);g.css({width:e+"px",height:c+"px"}).appendTo(a)}function pxToMm(a){return 25.4*pxToInches(a)}function mmToPx(a){return inchesToPx(a/25.4)}function pxToInches(a){return a/16}function inchesToPx(a){return 16*a}function toNearestTenth(a){return Math.round(10*a)/10}function colorForPlayer(a){return 1==a?"red":"blue"}
jQuery.base64=function(){function a(a,b){var d=c.indexOf(a.charAt(b));if(-1===d)throw"Cannot decode base64";return d}function b(a,b){var c=a.charCodeAt(b);if(255<c)throw"INVALID_CHARACTER_ERR: DOM Exception 5";return c}var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";return{decode:function(b){var c=0,d,g,h=b.length,i=[],b=String(b);if(0===h)return b;if(0!==h%4)throw"Cannot decode base64";"="===b.charAt(h-1)&&(c=1,"="===b.charAt(h-2)&&(c=2),h-=4);for(d=0;d<h;d+=4)g=a(b,d)<<
18|a(b,d+1)<<12|a(b,d+2)<<6|a(b,d+3),i.push(String.fromCharCode(g>>16,g>>8&255,g&255));switch(c){case 1:g=a(b,d)<<18|a(b,d+1)<<12|a(b,d+2)<<6;i.push(String.fromCharCode(g>>16,g>>8&255));break;case 2:g=a(b,d)<<18|a(b,d+1)<<12,i.push(String.fromCharCode(g>>16))}return i.join("")},encode:function(a){if(1!==arguments.length)throw"SyntaxError: exactly one argument required";var a=String(a),f,d,g=[],h=a.length-a.length%3;if(0===a.length)return a;for(f=0;f<h;f+=3)d=b(a,f)<<16|b(a,f+1)<<8|b(a,f+2),g.push(c.charAt(d>>
18)),g.push(c.charAt(d>>12&63)),g.push(c.charAt(d>>6&63)),g.push(c.charAt(d&63));switch(a.length-h){case 1:d=b(a,f)<<16;g.push(c.charAt(d>>18)+c.charAt(d>>12&63)+"==");break;case 2:d=b(a,f)<<16|b(a,f+1)<<8,g.push(c.charAt(d>>18)+c.charAt(d>>12&63)+c.charAt(d>>6&63)+"=")}return g.join("")},VERSION:"1.0"}}(jQuery);
